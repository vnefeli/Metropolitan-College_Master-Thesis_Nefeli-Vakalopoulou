# Load Seurat
library(Seurat)
library(dplyr)

rm(list = ls())
gc()

# Create Seurat object

seurat_obj <- readRDS("../data/ovary_seurat_cancer.rds")

# QC: Add percent mitochondrial content
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")

# Optional: Visualize QC metrics
#VlnPlot(seurat_obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"))


# Filter cells
# Example thresholds â€” adapt as needed!
seurat_obj <- subset(seurat_obj, 
                     subset = nFeature_RNA > 200 & 
                       percent.mt < 40)                      


# Normalize
seurat_obj <- NormalizeData(seurat_obj)


# Find variable features
seurat_obj <- FindVariableFeatures(seurat_obj, selection.method = "vst", nfeatures = 2000)


# Scale the data
seurat_obj <- ScaleData(seurat_obj)


# Run PCA
seurat_obj <- RunPCA(seurat_obj, features = VariableFeatures(object = seurat_obj))

# Visualize PCA
ElbowPlot(seurat_obj)


# Find neighbors & clusters
# Adjust dims based on your PCA results
seurat_obj <- FindNeighbors(seurat_obj, dims = 1:10)
seurat_obj <- FindClusters(seurat_obj, resolution = 0.5)


# Run UMAP
seurat_obj <- RunUMAP(seurat_obj, dims = 1:10)

DimPlot(seurat_obj, reduction = "umap", group.by = "condition", label = TRUE)


# Stratified downsampling to 5,000 cells (2,500 per condition)

# Set seed for reproducibility
set.seed(42)

# Get cells for each condition
cells_control <- Cells(seurat_obj)[seurat_obj$condition == "Normal"]
cells_cancer  <- Cells(seurat_obj)[seurat_obj$condition == "Cancer"]

# Adjust here for desired ratio â€” equal split:
n_control_target <- 2500
n_cancer_target  <- 2500

# Sample cells
downsampled_control <- sample(cells_control, n_control_target)
downsampled_cancer  <- sample(cells_cancer, n_cancer_target)

# Combine
downsampled_cells <- c(downsampled_control, downsampled_cancer)

# Subset
seurat_obj_downsampled <- subset(seurat_obj, cells = downsampled_cells)

# Plot downsampled UMAP
DimPlot(seurat_obj_downsampled, reduction = "umap", group.by = "condition", label = TRUE)

# Save Seurat filtered/downsampled for scMINER
saveRDS(seurat_obj_downsampled, file = "../data/ovary_seurat_cancer_downsampled.rds")
